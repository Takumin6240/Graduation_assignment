# Scratch学習支援システム - 技術仕様書(論文用)

本ドキュメントは、論文の第3章「提案」執筆時に参照する技術仕様をまとめたものです。

---

## 1. システム全体構成

### 1.1 システムアーキテクチャ

```
┌─────────────────┐
│   ユーザー      │ (小学生、管理者)
│  (ブラウザ)     │
└────────┬────────┘
         │ HTTP/HTTPS
         ↓
┌─────────────────┐
│   Frontend      │ React + TypeScript
│   (Port 3000)   │ Tailwind CSS
└────────┬────────┘
         │ REST API (JWT)
         ↓
┌─────────────────┐
│   Backend       │ Node.js + Express
│   (Port 5000)   │ Multer, JSZip
└────────┬────────┘
         │ SQL
         ↓
┌─────────────────┐
│  PostgreSQL     │ 学習データ保存
│   (Port 5432)   │ JSONB型でSB3保存
└─────────────────┘
```

### 1.2 主要コンポーネント

| コンポーネント | 技術スタック | 役割 |
|--------------|------------|------|
| フロントエンド | React 18, TypeScript, Tailwind CSS | UI表示、ユーザー操作 |
| バックエンド | Node.js, Express.js | ビジネスロジック、API提供 |
| データベース | PostgreSQL 14+ | データ永続化 |
| 認証 | JWT (jsonwebtoken) | ユーザー認証・認可 |
| ファイル処理 | Multer, JSZip | SB3アップロード・解析 |
| 採点エンジン | 独自実装(JavaScript) | セマンティック比較 |

---

## 2. データベース設計

### 2.1 ER図概要

```
[admins] 1───M [users]
              │
              │ admin_id
              │
[chapters] 1───M [problems] 1───M [hints]
              │                   │
              │ chapter_id         │ problem_id
              │                   │ grade (1-6)
              │ problem_id
              │
              M
              │
         [submissions] ←─── user_id, problem_id
              │
              │
         [submission_attempts]
```

### 2.2 テーブル詳細

#### users(学生)
```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  username VARCHAR(50) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  nickname VARCHAR(50),
  admin_id INTEGER REFERENCES admins(id),
  level INTEGER DEFAULT 1,
  exp INTEGER DEFAULT 0,
  grade INTEGER CHECK (grade BETWEEN 1 AND 6),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### admins(管理者)
```sql
CREATE TABLE admins (
  id SERIAL PRIMARY KEY,
  admin_username VARCHAR(50) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### chapters(章)
```sql
CREATE TABLE chapters (
  id SERIAL PRIMARY KEY,
  title VARCHAR(100) NOT NULL,
  description TEXT,
  order_number INTEGER NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### problems(問題)
```sql
CREATE TABLE problems (
  id SERIAL PRIMARY KEY,
  chapter_id INTEGER REFERENCES chapters(id),
  title VARCHAR(100) NOT NULL,
  description TEXT,
  problem_type VARCHAR(20) CHECK (problem_type IN ('fill_blank', 'predict', 'find_error', 'mission')),
  learning_objective TEXT,
  initial_sb3_data JSONB,  -- 初期SB3ファイル(JSONB形式)
  correct_sb3_data JSONB,  -- 正解SB3ファイル(JSONB形式)
  image_url VARCHAR(255),
  order_number INTEGER NOT NULL,
  difficulty INTEGER CHECK (difficulty BETWEEN 1 AND 5),
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### hints(ヒント)
```sql
CREATE TABLE hints (
  id SERIAL PRIMARY KEY,
  problem_id INTEGER REFERENCES problems(id),
  grade INTEGER CHECK (grade BETWEEN 1 AND 6),
  hint_text TEXT NOT NULL,
  order_number INTEGER NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### submissions(最終提出記録)
```sql
CREATE TABLE submissions (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  problem_id INTEGER REFERENCES problems(id),
  is_correct BOOLEAN,
  score NUMERIC(5,2),
  total_attempts INTEGER DEFAULT 1,
  completed_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, problem_id)  -- 1問につき1レコード
);
```

#### submission_attempts(全試行記録) ★研究用
```sql
CREATE TABLE submission_attempts (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  problem_id INTEGER REFERENCES problems(id),
  attempt_number INTEGER NOT NULL,
  submitted_sb3_data JSONB,  -- 提出されたSB3ファイル
  is_correct_attempt BOOLEAN,
  score NUMERIC(5,2),
  feedback JSONB,  -- フィードバック詳細
  timestamp TIMESTAMP DEFAULT NOW()
);
```

### 2.3 JSONB型の活用

**なぜJSONBを使うのか**:
- SB3ファイルの中身(project.json)は複雑な階層構造
- RDBの正規化では表現しづらい
- PostgreSQLのJSONB型なら高速検索・インデックス可能

**データ例**:
```json
{
  "targets": [
    {
      "isStage": true,
      "name": "Stage",
      "variables": {},
      "blocks": {}
    },
    {
      "isStage": false,
      "name": "Sprite1",
      "variables": {
        "var_id_123": ["カウンター", 0]
      },
      "blocks": {
        "block_id_456": {
          "opcode": "motion_movesteps",
          "inputs": { "STEPS": [1, [4, "10"]] }
        }
      }
    }
  ]
}
```

---

## 3. 採点エンジン(v2.1)の詳細

### 3.1 ファイルパス
`backend/src/services/scratchGradingEngine.js`

### 3.2 主要関数

#### 3.2.1 compareScratchPrograms(correctSB3, submittedSB3)
**役割**: 正解SB3と提出SB3を比較し、採点結果を返す

**処理フロー**:
```
1. normalizeProgram() - プログラムの正規化
   ├─ 変数名の正規化(カタカナ変換、空白除去)
   ├─ ブロックの抽出
   └─ メタデータの整理

2. extractRequirements() - 正解SB3から要件を抽出
   ├─ 必須ブロックリスト
   ├─ 各ブロックのパラメータ
   └─ 順序制約

3. mapVariables() ★v2.1の核心
   ├─ 正解の変数使用パターンを解析
   ├─ 提出の変数使用パターンを解析
   └─ パターンマッチングでマッピング

4. checkBlocks() - ブロック比較
   ├─ 必須ブロックの存在確認
   ├─ パラメータの柔軟マッチング(±10%)
   └─ 変数マッピングの適用

5. checkOrderConstraints() - 順序制約チェック

6. generateFeedback() - フィードバック生成
   ├─ 成功メッセージ
   ├─ 警告メッセージ
   └─ エラーメッセージ + ヒント
```

**戻り値**:
```javascript
{
  score: 85,        // スコア(0-100)
  isCorrect: true,  // 正解か
  feedback: {
    summary: "85点: よくできました!",
    details: [
      { type: "success", message: "繰り返しブロックが正しく使われています" },
      { type: "warning", message: "移動距離が少し違います(期待: 10, 実際: 9)" }
    ],
    hints: ["移動ブロックの数値を確認しましょう"]
  }
}
```

### 3.3 変数マッピングアルゴリズム

#### 3.3.1 設計思想
**問題**: 小学生は変数に自由な名前を付ける
- 正解: "counter", "score", "x座標"
- 生徒: "りんご", "かず", "ねこのいち"

**解決策**: 変数名を無視し、**使用パターン**で自動マッピング

#### 3.3.2 アルゴリズム詳細

```javascript
function mapVariables(correctProgram, submittedProgram) {
  // 1. 変数の使用パターンを抽出
  const correctUsage = analyzeVariableUsage(correctProgram);
  const submittedUsage = analyzeVariableUsage(submittedProgram);

  // correctUsage例:
  // {
  //   "counter": {
  //     "type": "number",
  //     "initialValue": 0,
  //     "usedInBlocks": ["data_changevariableby", "control_repeat"],
  //     "incrementPattern": true,
  //     "comparePattern": true
  //   }
  // }

  // 2. パターンマッチング
  const mapping = {};

  for (let correctVar of Object.keys(correctUsage)) {
    const correctPattern = correctUsage[correctVar];

    // 最も類似したパターンの変数を探す
    let bestMatch = null;
    let bestScore = 0;

    for (let submittedVar of Object.keys(submittedUsage)) {
      if (mapping[submittedVar]) continue; // 既にマッピング済み

      const similarity = calculateSimilarity(
        correctPattern,
        submittedUsage[submittedVar]
      );

      if (similarity > bestScore && similarity > 0.8) {
        bestScore = similarity;
        bestMatch = submittedVar;
      }
    }

    if (bestMatch) {
      mapping[correctVar] = bestMatch;
    }
  }

  return mapping;
  // 戻り値例: { "counter": "りんご", "score": "てんすう" }
}

function calculateSimilarity(pattern1, pattern2) {
  let score = 0;

  // 型が一致
  if (pattern1.type === pattern2.type) score += 0.3;

  // 初期値が近い
  if (Math.abs(pattern1.initialValue - pattern2.initialValue) < 5) score += 0.2;

  // 使用ブロックが一致
  const commonBlocks = intersection(pattern1.usedInBlocks, pattern2.usedInBlocks);
  score += (commonBlocks.length / pattern1.usedInBlocks.length) * 0.3;

  // インクリメントパターン一致
  if (pattern1.incrementPattern === pattern2.incrementPattern) score += 0.1;

  // 比較パターン一致
  if (pattern1.comparePattern === pattern2.comparePattern) score += 0.1;

  return score;
}
```

#### 3.3.3 マッピング後の比較

```javascript
// 正解: 変数"counter"を10増やす
// 提出: 変数"りんご"を10増やす

// マッピング: { "counter": "りんご" }

// 比較時:
if (correctBlock.fields.VARIABLE === "counter") {
  const mappedVar = mapping["counter"]; // "りんご"
  if (submittedBlock.fields.VARIABLE === mappedVar) {
    // OK! 変数名は違うが、マッピングされているので正解
  }
}
```

### 3.4 柔軟なパラメータマッチング

#### 3.4.1 数値の±10%許容

```javascript
function compareNumericParameter(expected, actual) {
  const tolerance = 0.1; // 10%
  const diff = Math.abs(expected - actual);
  const allowedDiff = expected * tolerance;

  if (diff === 0) {
    return { match: true, score: 1.0 };
  } else if (diff <= allowedDiff) {
    return {
      match: true,
      score: 0.8,
      warning: `少し違います(期待: ${expected}, 実際: ${actual})`
    };
  } else {
    return {
      match: false,
      score: 0,
      error: `数値が違います(期待: ${expected}, 実際: ${actual})`
    };
  }
}
```

**使用例**:
- 期待値: 10歩進む
- 提出値: 9歩進む
- 判定: ±10%(1歩)以内なので警告付きで正解(スコア0.8)

#### 3.4.2 ブロック順序の柔軟性

一部のブロックは順序を問わない:
```javascript
const orderIndependentBlocks = [
  'event_whenflagclicked',  // 旗クリックイベント
  'looks_*',                // 見た目系ブロック(順序自由)
];
```

---

## 4. フロントエンド実装詳細

### 4.1 ディレクトリ構成

```
frontend/
├── src/
│   ├── App.tsx                    # ルーター設定
│   ├── contexts/
│   │   └── AuthContext.tsx        # 認証状態管理
│   ├── services/
│   │   └── api.ts                 # API通信(Axios)
│   ├── pages/
│   │   ├── Home.tsx               # ホーム画面
│   │   ├── Login.tsx              # ログイン画面
│   │   ├── ChapterList.tsx        # 章一覧
│   │   ├── ProblemPage.tsx        # 問題画面
│   │   ├── Progress.tsx           # 進捗画面
│   │   └── AdminDashboard.tsx     # 管理者画面
│   ├── components/
│   │   ├── Header.tsx             # ヘッダー
│   │   ├── Footer.tsx             # フッター
│   │   ├── HintBubble.tsx         # ヒント表示
│   │   ├── FeedbackDisplay.tsx    # フィードバック表示 ★重要
│   │   ├── Loading.tsx            # ローディング
│   │   └── ProtectedRoute.tsx     # 認証ルート保護
│   └── types/
│       └── index.ts               # TypeScript型定義
└── public/
    └── initial_sb3/               # 初期SB3ファイル
```

### 4.2 主要コンポーネント

#### 4.2.1 FeedbackDisplay.tsx
**役割**: 採点結果のフィードバックを視覚的に表示

**Props**:
```typescript
interface FeedbackDisplayProps {
  feedback: {
    summary: string;
    details: Array<{
      type: 'success' | 'warning' | 'error';
      message: string;
    }>;
    hints: string[];
  };
  score: number;
  isCorrect: boolean;
}
```

**表示例**:
```tsx
<FeedbackDisplay
  score={85}
  isCorrect={true}
  feedback={{
    summary: "85点: よくできました!",
    details: [
      { type: "success", message: "繰り返しブロックが正しく使われています" },
      { type: "warning", message: "移動距離が少し違います" }
    ],
    hints: ["移動ブロックの数値を確認しましょう"]
  }}
/>
```

#### 4.2.2 AuthContext.tsx
**役割**: 認証状態のグローバル管理

```typescript
interface AuthContextType {
  user: User | null;
  admin: Admin | null;
  login: (username: string, password: string, userType: 'student' | 'admin') => Promise<void>;
  logout: () => void;
  isAuthenticated: boolean;
}
```

**使用例**:
```typescript
const { user, isAuthenticated } = useAuth();

if (!isAuthenticated) {
  return <Navigate to="/login" />;
}
```

### 4.3 API通信(api.ts)

**Axiosインスタンス**:
```typescript
const api = axios.create({
  baseURL: 'http://localhost:5000/api',
  headers: {
    'Content-Type': 'application/json'
  }
});

// JWTトークン自動付与
api.interceptors.request.use((config) => {
  const token = localStorage.getItem('token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});
```

**主要APIエンドポイント**:
```typescript
// 認証
export const login = (username: string, password: string, userType: string) =>
  api.post('/auth/login', { username, password, userType });

// 章・問題取得
export const getChapters = () => api.get('/problems/chapters');
export const getProblem = (id: number) => api.get(`/problems/${id}`);

// 提出・採点
export const submitSB3 = (problemId: number, file: File) => {
  const formData = new FormData();
  formData.append('sb3', file);
  return api.post(`/submissions/${problemId}`, formData, {
    headers: { 'Content-Type': 'multipart/form-data' }
  });
};

// 進捗取得
export const getUserProgress = () => api.get('/users/progress');
```

---

## 5. バックエンド実装詳細

### 5.1 ディレクトリ構成

```
backend/
├── src/
│   ├── server.js                        # エントリーポイント
│   ├── config/
│   │   └── database.js                  # DB接続設定
│   ├── middleware/
│   │   └── auth.js                      # JWT認証ミドルウェア
│   ├── controllers/
│   │   ├── authController.js            # 認証ロジック
│   │   ├── problemController.js         # 問題取得ロジック
│   │   ├── submissionController.js      # 提出・採点ロジック ★
│   │   └── adminController.js           # 管理者機能
│   ├── routes/
│   │   ├── auth.js                      # 認証ルート
│   │   ├── problems.js                  # 問題ルート
│   │   ├── submissions.js               # 提出ルート
│   │   └── admin.js                     # 管理者ルート
│   ├── services/
│   │   └── scratchGradingEngine.js      # 採点エンジン ★★★
│   ├── db/
│   │   ├── migrations/                  # マイグレーションSQL
│   │   └── seed.js                      # 初期データ投入
│   └── utils/
│       └── logger.js                    # ログ記録
└── logs/                                # ログファイル出力先
```

### 5.2 主要コントローラー

#### 5.2.1 submissionController.js

**submitSB3()関数**:
```javascript
exports.submitSB3 = async (req, res) => {
  try {
    // 1. アップロードファイルの取得
    const file = req.file; // Multerで処理済み
    const userId = req.user.id;
    const problemId = req.params.problemId;

    // 2. SB3ファイルの解析
    const zip = await JSZip.loadAsync(file.buffer);
    const projectJSON = await zip.file('project.json').async('string');
    const submittedSB3 = JSON.parse(projectJSON);

    // 3. 正解SB3の取得
    const problem = await db.query(
      'SELECT correct_sb3_data FROM problems WHERE id = $1',
      [problemId]
    );
    const correctSB3 = problem.rows[0].correct_sb3_data;

    // 4. 採点エンジン呼び出し ★
    const gradingResult = compareScratchPrograms(correctSB3, submittedSB3);

    // 5. submission_attemptsに記録(研究用)
    const attemptNumber = await getNextAttemptNumber(userId, problemId);
    await db.query(
      `INSERT INTO submission_attempts
       (user_id, problem_id, attempt_number, submitted_sb3_data, is_correct_attempt, score, feedback)
       VALUES ($1, $2, $3, $4, $5, $6, $7)`,
      [userId, problemId, attemptNumber, submittedSB3, gradingResult.isCorrect, gradingResult.score, gradingResult.feedback]
    );

    // 6. submissionsテーブルの更新(UPSERT)
    await db.query(
      `INSERT INTO submissions (user_id, problem_id, is_correct, score, total_attempts)
       VALUES ($1, $2, $3, $4, 1)
       ON CONFLICT (user_id, problem_id)
       DO UPDATE SET
         is_correct = EXCLUDED.is_correct,
         score = EXCLUDED.score,
         total_attempts = submissions.total_attempts + 1,
         completed_at = NOW()`,
      [userId, problemId, gradingResult.isCorrect, gradingResult.score]
    );

    // 7. レベル・経験値の更新
    if (gradingResult.isCorrect) {
      await updateUserExp(userId, calculateExp(gradingResult.score));
    }

    // 8. 結果を返す
    res.json({
      success: true,
      score: gradingResult.score,
      isCorrect: gradingResult.isCorrect,
      feedback: gradingResult.feedback
    });

  } catch (error) {
    logger.error('Submission error:', error);
    res.status(500).json({ error: 'Submission failed' });
  }
};
```

### 5.3 認証ミドルウェア

**auth.js**:
```javascript
// 学生用認証
exports.authMiddleware = (req, res, next) => {
  const token = req.headers.authorization?.split(' ')[1];

  if (!token) {
    return res.status(401).json({ error: 'No token provided' });
  }

  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);

    if (decoded.userType !== 'student') {
      return res.status(403).json({ error: 'Student access required' });
    }

    req.user = decoded; // { id, username, userType }
    next();
  } catch (error) {
    return res.status(401).json({ error: 'Invalid token' });
  }
};

// 管理者用認証
exports.adminAuthMiddleware = (req, res, next) => {
  // 同様の実装、userType === 'admin' をチェック
};
```

---

## 6. 開発環境・デプロイ

### 6.1 Docker Compose構成

**docker-compose.yml**:
```yaml
version: '3.8'

services:
  postgres:
    image: postgres:14
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: scratch_learning
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    ports:
      - "5000:5000"
    environment:
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/scratch_learning
      JWT_SECRET: your_jwt_secret_key
    volumes:
      - ./backend:/app
      - /app/node_modules
    depends_on:
      - postgres

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
    environment:
      REACT_APP_API_URL: http://localhost:5000
    volumes:
      - ./frontend:/app
      - /app/node_modules
    depends_on:
      - backend

volumes:
  postgres_data:
```

### 6.2 起動コマンド

```bash
# 初回起動
docker-compose up --build -d
docker-compose exec backend npm run migrate
docker-compose exec backend node src/db/seed.js

# 日常開発
docker-compose up -d
docker-compose logs -f backend
docker-compose restart backend

# データベースリセット
docker-compose down -v
docker-compose up -d
docker-compose exec backend npm run migrate
docker-compose exec backend node src/db/seed.js
```

---

## 7. ログ管理(研究用)

### 7.1 logger.js

**自動ログ記録**:
```javascript
const fs = require('fs');
const path = require('path');

const logDir = path.join(__dirname, '../../logs');

// ログディレクトリ作成
if (!fs.existsSync(logDir)) {
  fs.mkdirSync(logDir);
}

// ファイル名: YYYYMMDD_HHMMSS_server.log
const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
const logFile = path.join(logDir, `${timestamp}_server.log`);

const logger = {
  info: (message) => {
    const log = `[INFO] ${new Date().toISOString()} - ${message}\n`;
    fs.appendFileSync(logFile, log);
    console.log(log);
  },
  error: (message, error) => {
    const log = `[ERROR] ${new Date().toISOString()} - ${message}\n${error?.stack}\n`;
    fs.appendFileSync(logFile, log);
    console.error(log);
  }
};

module.exports = logger;
```

**使用例**:
```javascript
logger.info(`User ${userId} submitted problem ${problemId}`);
logger.error('Grading engine error', error);
```

**研究における重要性**:
- 全ての学習活動を記録
- 問題発生時のデバッグ
- 論文の実験データとして活用

---

## 8. データフロー図

### 8.1 提出・採点フロー

```
[学生]
  │
  │ 1. SB3ファイルをアップロード
  ↓
[Frontend: ProblemPage.tsx]
  │
  │ 2. FormData作成、api.submitSB3()
  ↓
[Backend: /api/submissions/:problemId (POST)]
  │
  │ 3. authMiddleware → JWT検証
  ↓
[submissionController.submitSB3()]
  │
  │ 4. JSZipでSB3解析
  │ 5. 正解SB3を取得(PostgreSQL)
  ↓
[scratchGradingEngine.compareScratchPrograms()]
  │
  │ 6. 変数マッピング(v2.1)
  │ 7. ブロック比較
  │ 8. フィードバック生成
  ↓
[submissionController]
  │
  │ 9. submission_attempts記録
  │ 10. submissions更新
  │ 11. 経験値更新
  ↓
[Frontend: FeedbackDisplay.tsx]
  │
  │ 12. フィードバック表示
  ↓
[学生] 結果確認
```

---

## 9. セキュリティ対策

### 9.1 実装済み対策

1. **JWT認証**
   - トークンの有効期限設定
   - HTTPSでの通信(本番環境)

2. **パスワードハッシュ化**
   - bcryptによるハッシュ化(salt rounds: 10)

3. **SQLインジェクション対策**
   - プリペアドステートメント使用

4. **CORS設定**
   - 許可オリジンの明示的指定

5. **ファイルアップロード制限**
   - Multerによるファイルサイズ制限
   - 拡張子チェック(.sb3のみ許可)

### 9.2 今後の課題

- レート制限(Rate Limiting)
- CSRFトークン
- XSS対策の強化

---

## 10. パフォーマンス最適化

### 10.1 実装済み最適化

1. **データベース**
   - インデックス設定(user_id, problem_id)
   - JSONB型の活用

2. **フロントエンド**
   - React.memoによる再レンダリング抑制
   - Lazy Loadingの検討

3. **バックエンド**
   - 接続プール(PostgreSQL)
   - 非同期処理(async/await)

### 10.2 今後の最適化

- CDNの活用
- キャッシュ戦略
- 大規模データ時のページネーション

---

## まとめ

このシステムの技術的な特徴:

1. **変数マッピング機能(v2.1)** - 最大の技術的貢献
2. **JSONB型の活用** - 柔軟なSB3データ保存
3. **submission_attempts** - 研究用の詳細データ記録
4. **JWT + ミドルウェア** - 学生/管理者の分離
5. **Docker Compose** - 再現可能な開発環境

論文執筆時は、特に**採点エンジン(第3.5節相当)**と**変数マッピング(第3.5.2節相当)**を詳細に記述することが重要です。
