# Scratch採点システム解説 v2.2

## バージョン情報

**更新日**: 2025-11-07
**バージョン**: 2.2
**実装ファイル**: `backend/src/services/scratchGradingEngine.js`

## v2.2 の改善内容

### 1. 全ブロックタイプの値判別機能

**改善前の問題**:
- 主に「動き」ブロックの値しか判別できていなかった
- 制御、見た目、音、イベントなどの他のカテゴリのブロックの値が正しくチェックされない

**改善内容**:
- 全150種類以上のScratchブロックのラベルを定義（BLOCK_LABELS）
- 以下のカテゴリを完全サポート：
  - **イベント** (8種類): 緑の旗、キー押下、ブロードキャストなど
  - **動き** (15種類): 歩動かす、回す、座標移動など
  - **見た目** (16種類): 言う、表示/非表示、コスチューム変更など
  - **音** (8種類): 音を鳴らす、音量調整など
  - **制御** (11種類): 繰り返す、待つ、条件分岐など
  - **調べる** (19種類): 触れた、距離、タイマーなど
  - **演算** (15種類): 四則演算、比較、論理演算など
  - **データ** (14種類): 変数、リスト操作など
  - **ペン** (9種類): ペン操作、色設定など
  - **音楽拡張** (6種類): 楽器、テンポなど

**効果**:
```javascript
// 例1: 制御ブロックの値判別
正解: 「10回繰り返す」
提出: 「5回繰り返す」
結果: ✗ 「○回繰り返す」ブロックはありますが、回数の値が間違っています（正解: 10、あなた: 5）

// 例2: 見た目ブロックの値判別
正解: 「2秒待つ」
提出: 「5秒待つ」
結果: ✗ 「○秒待つ」ブロックはありますが、秒数の値が間違っています（正解: 2、あなた: 5）
```

### 2. 値の誤差判定の改善

**改善前の問題**:
- 正解の値から近い数字（±10%以内）ならヒントを出すが、大幅に離れていると「ブロックがありません」と表示されていた
- 実際にはブロックは存在するのに、値が間違っているだけなのに「ブロックがない」と誤解される

**改善内容**:
1. **ブロックの存在チェックと値のチェックを分離**
   ```javascript
   // Step 1: opcodeだけでブロックを検索（値は無視）
   const foundBlocks = findBlocks(program, requirement.opcode);

   // Step 2: ブロックが見つかった場合、値をチェック
   if (foundBlocks.length > 0) {
     const matchResult = checkInputMatch(block.inputs, requirement.inputs);
   }
   ```

2. **3段階の値判定**
   - **完全一致** (exactMatch): 値が完全に一致 → 満点
   - **近い値** (closeMatch): ±10%以内 → 80%の点数、「少し違います」と表示
   - **大幅に違う値** (wrong): ±10%を超える → 30%の点数、「値が間違っています」と明確に指摘

**効果**:
```javascript
// 改善前
正解: 10歩動かす
提出: 100歩動かす
結果: ✗ 「○歩動かす」ブロックがありません  // 誤解を招く！

// 改善後
正解: 10歩動かす
提出: 100歩動かす
結果: △ 「○歩動かす」ブロックはありますが、歩数の値が間違っています（正解: 10、あなた: 100）
```

### 3. 余分なブロック・変数の検出機能

**新機能**:
- 正解には含まれていない余分なブロックを検出
- 余分な変数を検出
- 警告として表示（減点はしない）

**実装方法**:
1. **余分なブロック検出** (`detectExtraBlocks`)
   ```javascript
   // 提出されたブロックと正解のブロックをカウント
   const submittedBlockCounts = { motion_movesteps: 2, looks_say: 1 };
   const correctBlockCounts = { motion_movesteps: 2 };

   // 差分を検出
   extraBlocks = [{ label: '○と言う', extraCount: 1 }];
   ```

2. **余分な変数検出** (`detectExtraVariables`)
   ```javascript
   // 提出された変数と正解の変数を比較
   const submittedVars = new Set(['カウンター', 'スコア', 'テスト']);
   const correctVars = new Set(['カウンター', 'スコア']);

   // 差分を検出
   extraVars = ['テスト'];
   ```

**効果**:
```javascript
正解: 10歩動かす
提出: 10歩動かす + 「こんにちは」と言う
結果:
  ✓ 「緑の旗がクリックされたとき」ブロックがあります
  ✓ 「○歩動かす」ブロックがあります
  ⚠ 余分な「○と言う」ブロックが1個含まれています
ヒント: 「○と言う」ブロックが多すぎます。不要なブロックを削除してください
```

### 4. 点数に応じたきめ細かいメッセージ

**改善前**:
```javascript
100点: 完璧です！
80-99点: 正解です！
60-79点: あと少しで正解です！
40-59点: いい感じです！
0-39点: もう一度確認してみましょう。
```

**改善後**:
```javascript
100点: 完璧です！プログラムが正解と完全に一致しています。
90-99点: 素晴らしい！ほぼ完璧です。
85-89点: あともう少しで完璧です！  // ★新規追加
80-84点: 正解です！よくできました。
70-79点: いい感じです！もう少し頑張りましょう。
60-69点: あと少しで正解です！もう一息です。
40-59点: まだいくつか修正が必要です。ヒントを確認してください。
0-39点: もう一度確認してみましょう。下のヒントを参考にしてください。
```

**効果**:
- 85点前後（惜しい点数）の学生に対して、より励ましのメッセージを表示
- 70-79点の範囲も細分化して、より適切なフィードバックを提供

## 技術的な詳細

### 入力パラメータのラベル定義

わかりやすいフィードバックのために、入力パラメータの日本語ラベルを定義：

```javascript
const INPUT_LABELS = {
  'STEPS': '歩数',
  'DEGREES': '角度',
  'X': 'x座標',
  'Y': 'y座標',
  'SECS': '秒数',
  'MESSAGE': 'メッセージ',
  'TIMES': '回数',
  'VALUE': '値',
  'DURATION': '長さ',
  'VOLUME': '音量',
  'SIZE': '大きさ',
  'CHANGE': '変化量'
};
```

### 値の比較ロジック

```javascript
function checkInputMatch(actualInputs, expectedInputs) {
  for (const [key, expectedValue] of Object.entries(expectedInputs)) {
    const actualValue = actualInputs[key];

    if (typeof expectedValue === 'number' && typeof actualValue === 'number') {
      const diff = Math.abs(actualValue - expectedValue);
      const tolerance = Math.abs(expectedValue) * 0.1; // ±10%

      if (diff === 0) {
        // 完全一致
        status = 'exact';
      } else if (diff <= tolerance) {
        // 近い値
        status = 'close';
      } else {
        // 大幅に違う
        status = 'wrong';
      }
    } else if (actualValue === expectedValue) {
      // 文字列等の完全一致
      status = 'exact';
    } else {
      // 不一致
      status = 'wrong';
    }
  }
}
```

## テスト結果

### テスト1: 値が大幅に間違っている場合

```
正解: 10歩動かす
提出: 100歩動かす
スコア: 65点
サマリー: あと少しで正解です！もう一息です。
詳細:
  ✓ 「緑の旗がクリックされたとき」ブロックがあります
  △ 「○歩動かす」ブロックはありますが、歩数の値が間違っています（正解: 10、あなた: 100）
ヒント: [ '「動き」カテゴリを確認してください' ]
```

### テスト2: 余分なブロックがある場合

```
正解: 10歩動かす
提出: 10歩動かす + 「こんにちは」と言う
スコア: 100点
サマリー: 完璧です！プログラムが正解と完全に一致しています。
詳細:
  ✓ 「緑の旗がクリックされたとき」ブロックがあります
  ✓ 「○歩動かす」ブロックがあります
  ⚠ 余分な「○と言う」ブロックが1個含まれています
ヒント: [ '「○と言う」ブロックが多すぎます。不要なブロックを削除してください' ]
```

### テスト3: 制御ブロックの値判別

```
正解: 10回繰り返す
提出: 5回繰り返す
スコア: 65点
サマリー: あと少しで正解です！もう一息です。
詳細:
  ✓ 「緑の旗がクリックされたとき」ブロックがあります
  △ 「○回繰り返す」ブロックはありますが、回数の値が間違っています（正解: 10、あなた: 5）
ヒント: [ '「制御」カテゴリを確認してください' ]
```

## まとめ

v2.2の改善により、以下が実現されました：

1. ✅ **全ブロックタイプの値判別**: 150種類以上のブロックに対応
2. ✅ **明確なエラーメッセージ**: 「ブロックがありません」ではなく「値が間違っています」と明示
3. ✅ **余分な要素の検出**: 不要なブロックや変数を警告
4. ✅ **きめ細かいフィードバック**: 85点で「あともう少し」など、学習者を励ますメッセージ

これにより、小学生でもわかりやすく、学習効果の高い採点システムが実現されました。
