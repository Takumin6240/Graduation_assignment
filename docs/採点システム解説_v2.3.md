# Scratch採点システム解説 v2.3（最終版）

## バージョン情報

**更新日**: 2025-11-07
**バージョン**: 2.3（見やすさ重視版）
**実装ファイル**: `backend/src/services/scratchGradingEngine.js`

## v2.3 の改善内容（見やすさ重視）

複雑な総合問題でも小学生が理解しやすいフィードバックを実現するため、以下の改善を実施しました。

### 1. エラーの優先度付け ✅

**目的**: 重要な問題から順に表示することで、どこから修正すべきかが一目で分かる

**優先度の定義**:
```javascript
PRIORITY.CRITICAL (3)  // ブロックが完全に欠けている
PRIORITY.HIGH (2)      // 値が大幅に間違っている
PRIORITY.MEDIUM (1)    // 値が少し違う、余分な要素
PRIORITY.SUCCESS (0)   // 成功（非表示）
```

**効果**:
```
改善前（順不同）:
  ✗ 「○と言う」ブロックがありません
  △ 「○歩動かす」ブロックはありますが、歩数の値が少し違います
  ✗ 「○秒待つ」ブロックがありません
  ⚠ 余分なブロックが1個含まれています

改善後（優先度順）:
  ✗ 「○と言う」ブロックがありません           ← 最優先（CRITICAL）
  ✗ 「○秒待つ」ブロックがありません           ← 最優先（CRITICAL）
  △ 「○歩動かす」ブロックはありますが、...   ← 次に重要（HIGH/MEDIUM）
  ⚠ 余分なブロックが1個含まれています        ← 低優先度（MEDIUM）
```

### 2. 正解している部分は表示しない ✅

**改善前の問題**:
- 正解している部分（✓マーク）も大量に表示されていた
- 間違いが埋もれてしまい、何を直すべきか分かりにくい

**改善内容**:
- 成功メッセージ（✓マーク）は一切表示しない
- エラーと警告のみを表示
- 間違いに集中できる

**効果**:
```
改善前（正解も表示）:
  ✓ 「緑の旗がクリックされたとき」ブロックがあります
  ✓ 「○歩動かす」ブロックがあります
  ✓ 「○を○にする」ブロックがあります
  ✗ 「○秒待つ」ブロックがありません
  ✓ 「○と言う」ブロックがあります
  ✓ 「隠す」ブロックがあります

改善後（エラーのみ表示）:
  ✗ 「○秒待つ」ブロックがありません
```

### 3. すべてのエラーを表示（制限なし） ✅

**当初の案**: エラーを最大5個までに制限して「他にも○個の問題があります」と表示

**ユーザーフィードバック**: 制限は不要。すべてのエラーを見たい

**最終実装**:
- すべてのエラーと警告を優先度順に表示
- 「他にも○個の問題があります」のメッセージは削除
- 全体像を把握できる

### 4. カテゴリ別サマリー ✅

**目的**: 問題の多いカテゴリを強調することで、学習のポイントが分かる

**実装**:
- エラーが3個以上ある場合に自動生成
- 問題の多い順に最大3カテゴリを表示
- サマリーメッセージに追加

**効果**:
```
スコア: 21点
サマリー: もう一度確認してみましょう。 問題の多いカテゴリ: 順序(6個)、動き(2個)、データ(2個)
```

これにより、学習者は「順序」の問題が最も多いことが一目で分かります。

### 5. ヒントは最大3個まで（優先度順、重複削除） ✅

**目的**: ヒントが多すぎると混乱するため、最も重要なヒントのみを表示

**実装**:
```javascript
// ヒントを優先度順にソート、重複を削除、最大3個まで
const uniqueHints = [];
const seenMessages = new Set();

allHints.sort((a, b) => b.priority - a.priority);

for (const hint of allHints) {
  if (!seenMessages.has(hint.message) && uniqueHints.length < 3) {
    uniqueHints.push(hint.message);
    seenMessages.add(hint.message);
  }
}
```

**効果**:
```
ヒント（最大3個まで表示）:
  1. 「動き」カテゴリから「右に○度回す」ブロックを追加してみましょう
  2. 「データ」カテゴリから「○を○ずつ変える」ブロックを追加してみましょう
  3. 「制御」カテゴリから「○秒待つ」ブロックを追加してみましょう
```

## テスト結果（複雑な総合問題）

### テストケース
- **正解**: 10個のブロック
- **提出**: 8個のエラー（ブロック欠落3個、値の間違い5個）
- **余分な要素**: 余分なブロック1個、余分な変数2個

### 出力結果

```
スコア: 21
サマリー: もう一度確認してみましょう。 問題の多いカテゴリ: 順序(6個)、動き(2個)、データ(2個)

詳細（すべて表示）:
  1. ✗ 「右に○度回す」ブロックがありません
  2. ✗ 「○を○ずつ変える」ブロックがありません
  3. ✗ 「○秒待つ」ブロックがありません
  4. ✗ 「○と言う」ブロックがありません
  5. ✗ 「○の音を鳴らす」ブロックがありません
  6. ✗ 「隠す」ブロックがありません
  7. △ 「○を○にする」ブロックはありますが、値の値が間違っています（正解: 0、あなた: 5）
  8. △ 「○回繰り返す」ブロックはありますが、回数の値が間違っています（正解: 10、あなた: 20）
  9. △ 「○歩動かす」ブロックはありますが、歩数の値が間違っています（正解: 10、あなた: 100）
  10. ✗ 「○歩動かす」は「右に○度回す」の前にある必要があります
  11. ✗ 「右に○度回す」は「○を○ずつ変える」の前にある必要があります
  12. ✗ 「○を○ずつ変える」は「○秒待つ」の前にある必要があります
  13. ✗ 「○秒待つ」は「○と言う」の前にある必要があります
  14. ✗ 「○と言う」は「○の音を鳴らす」の前にある必要があります
  15. ✗ 「○の音を鳴らす」は「隠す」の前にある必要があります
  16. ⚠ 余分な変数が2個含まれています

ヒント（最大3個まで表示）:
  1. 「動き」カテゴリから「右に○度回す」ブロックを追加してみましょう
  2. 「データ」カテゴリから「○を○ずつ変える」ブロックを追加してみましょう
  3. 「制御」カテゴリから「○秒待つ」ブロックを追加してみましょう
```

## v2.2からv2.3への変更点まとめ

| 項目 | v2.2 | v2.3 |
|------|------|------|
| エラー表示順 | 発見順 | **優先度順** |
| 正解メッセージ | 表示する（✓マーク） | **表示しない** |
| エラー表示数 | 制限なし | **制限なし（維持）** |
| カテゴリサマリー | なし | **3個以上のエラーで自動表示** |
| ヒント数 | 重複あり、無制限 | **最大3個、重複削除、優先度順** |
| 励ましメッセージ | 90点以上 | **90-99点のみ** |

## v2.1 → v2.2 → v2.3 の進化

### v2.1（基本機能）
- 変数マッピング機能

### v2.2（機能拡張）
- 全ブロックタイプの値判別（150種類以上）
- 値の誤差判定改善（大幅な誤りでも「値が間違っている」と指摘）
- 余分なブロック・変数の検出
- 点数に応じたきめ細かいメッセージ

### v2.3（見やすさ重視）★最新版★
- エラーの優先度付け
- 正解部分の非表示
- カテゴリ別サマリー
- ヒントの厳選（最大3個）
- すべてのエラーを表示

## 小学生にとってのメリット

1. **どこから直すべきかが分かる**: 優先度順の表示
2. **間違いに集中できる**: 正解部分は非表示
3. **全体像が把握できる**: すべてのエラーを表示
4. **学習のポイントが分かる**: カテゴリ別サマリー
5. **迷わない**: 最重要ヒント3個のみ表示

## まとめ

v2.3では、v2.2の強力な機能（全ブロック判別、値判定改善等）はそのままに、**複雑な総合問題でも小学生が理解しやすいフィードバック**を実現しました。

エラーが多い場合でも：
- ✅ 重要な問題から順に表示
- ✅ 正解部分は表示せず、間違いに集中
- ✅ カテゴリ別サマリーで学習ポイントを強調
- ✅ 最重要ヒント3個で迷わせない

これにより、小学生でも自力で問題を修正しやすくなり、学習効果が大幅に向上しました。
